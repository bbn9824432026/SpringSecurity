# Spring Security Micro-Level Architecture

## 1. Core Architecture Overview

```
HTTP Request → Filter Chain → DispatcherServlet → Controllers
     ↑              ↑
SecurityFilterChain   Spring Security Filters
```

## 2. Security Filter Chain Architecture

### 2.1 DelegatingFilterProxy
```java
// Entry point - Servlet Container Level
DelegatingFilterProxy (javax.servlet.Filter)
    ↓
FilterChainProxy (Spring Security's main filter)
    ↓
List<SecurityFilterChain> - Multiple filter chains
```

### 2.2 SecurityFilterChain Components
```
SecurityFilterChain
├── RequestMatcher (determines if chain applies)
├── List<Filter> (ordered security filters)
└── SecurityContextRepository
```

## 3. Complete Filter Chain Execution Order

### 3.1 Pre-Authentication Filters
1. **ForceEagerSessionCreationFilter**
   - Forces session creation if needed
   - Location: `org.springframework.security.web.session`

2. **ChannelProcessingFilter**
   - HTTP/HTTPS channel security
   - Location: `org.springframework.security.web.access.channel`

3. **WebAsyncManagerIntegrationFilter**
   - Integrates SecurityContext with async requests
   - Location: `org.springframework.security.web.context`

4. **SecurityContextPersistenceFilter** (Deprecated)
   - Replaced by SecurityContextHolderFilter
   - Location: `org.springframework.security.web.context`

5. **SecurityContextHolderFilter**
   - Loads/saves SecurityContext
   - Location: `org.springframework.security.web.context`

### 3.2 Request Processing Filters
6. **HeaderWriterFilter**
   - Adds security headers
   - Location: `org.springframework.security.web.header`

7. **CorsFilter**
   - Cross-Origin Resource Sharing
   - Location: `org.springframework.web.filter`

8. **CsrfFilter**
   - Cross-Site Request Forgery protection
   - Location: `org.springframework.security.web.csrf`

9. **LogoutFilter**
   - Handles logout requests
   - Location: `org.springframework.security.web.authentication.logout`

### 3.3 Authentication Filters
10. **OAuth2AuthorizationRequestRedirectFilter**
    - OAuth2 authorization requests
    - Location: `org.springframework.security.oauth2.client.web`

11. **Saml2WebSsoAuthenticationRequestFilter**
    - SAML2 SSO authentication
    - Location: `org.springframework.security.saml2.provider.service.web`

12. **X509AuthenticationFilter**
    - X.509 certificate authentication
    - Location: `org.springframework.security.web.authentication.preauth.x509`

13. **AbstractPreAuthenticatedProcessingFilter**
    - Pre-authenticated scenarios
    - Location: `org.springframework.security.web.authentication.preauth`

14. **CasAuthenticationFilter**
    - Central Authentication Service
    - Location: `org.springframework.security.cas.web`

15. **OAuth2LoginAuthenticationFilter**
    - OAuth2 login processing
    - Location: `org.springframework.security.oauth2.client.web`

16. **Saml2WebSsoAuthenticationFilter**
    - SAML2 authentication processing
    - Location: `org.springframework.security.saml2.provider.service.web`

17. **UsernamePasswordAuthenticationFilter**
    - Form-based authentication
    - Location: `org.springframework.security.web.authentication`

18. **OpenIDAuthenticationFilter**
    - OpenID authentication
    - Location: `org.springframework.security.openid`

19. **DefaultLoginPageGeneratingFilter**
    - Generates default login page
    - Location: `org.springframework.security.web.authentication.ui`

20. **DefaultLogoutPageGeneratingFilter**
    - Generates default logout page
    - Location: `org.springframework.security.web.authentication.ui`

21. **ConcurrentSessionFilter**
    - Concurrent session handling
    - Location: `org.springframework.security.web.session`

22. **DigestAuthenticationFilter**
    - HTTP Digest authentication
    - Location: `org.springframework.security.web.authentication.www`

23. **BearerTokenAuthenticationFilter**
    - OAuth2 Resource Server
    - Location: `org.springframework.security.oauth2.server.resource.web`

24. **BasicAuthenticationFilter**
    - HTTP Basic authentication
    - Location: `org.springframework.security.web.authentication.www`

### 3.4 Authorization Filters
25. **RequestCacheAwareFilter**
    - Request caching for redirects
    - Location: `org.springframework.security.web.savedrequest`

26. **SecurityContextHolderAwareRequestFilter**
    - Wraps request with security context
    - Location: `org.springframework.security.web.servletapi`

27. **JaasApiIntegrationFilter**
    - JAAS integration
    - Location: `org.springframework.security.web.jaasapi`

28. **RememberMeAuthenticationFilter**
    - Remember-me functionality
    - Location: `org.springframework.security.web.authentication.rememberme`

29. **AnonymousAuthenticationFilter**
    - Anonymous user handling
    - Location: `org.springframework.security.web.authentication`

30. **OAuth2AuthorizationCodeGrantFilter**
    - OAuth2 authorization code handling
    - Location: `org.springframework.security.oauth2.client.web`

31. **SessionManagementFilter**
    - Session management policies
    - Location: `org.springframework.security.web.session`

32. **ExceptionTranslationFilter**
    - Exception handling and translation
    - Location: `org.springframework.security.web.access`

33. **FilterSecurityInterceptor** (Deprecated)
    - Final authorization check
    - Location: `org.springframework.security.web.access.intercept`

34. **AuthorizationFilter**
    - New authorization mechanism
    - Location: `org.springframework.security.web.access.intercept`

## 4. Core Components Deep Dive

### 4.1 SecurityContext Architecture
```
SecurityContextHolder (ThreadLocal storage)
├── SecurityContext (interface)
│   └── SecurityContextImpl
│       └── Authentication (current user)
├── SecurityContextHolderStrategy
│   ├── ThreadLocalSecurityContextHolderStrategy
│   ├── InheritableThreadLocalSecurityContextHolderStrategy
│   └── GlobalSecurityContextHolderStrategy
└── SecurityContextRepository
    ├── HttpSessionSecurityContextRepository
    ├── NullSecurityContextRepository
    └── DelegatingSecurityContextRepository
```

### 4.2 Authentication Architecture
```
Authentication (interface)
├── Principal (user identity)
├── Credentials (password/token)
├── Authorities (granted authorities)
├── Details (additional information)
└── Authenticated (boolean flag)

Implementations:
├── UsernamePasswordAuthenticationToken
├── AnonymousAuthenticationToken
├── RememberMeAuthenticationToken
├── PreAuthenticatedAuthenticationToken
├── OAuth2AuthenticationToken
├── JwtAuthenticationToken
└── TestingAuthenticationToken
```

### 4.3 AuthenticationManager Architecture
```
AuthenticationManager (interface)
├── authenticate(Authentication) -> Authentication
└── ProviderManager (main implementation)
    ├── List<AuthenticationProvider>
    ├── AuthenticationEventPublisher
    ├── parent (AuthenticationManager)
    └── eraseCredentialsAfterAuthentication
```

### 4.4 AuthenticationProvider Hierarchy
```
AuthenticationProvider (interface)
├── authenticate(Authentication) -> Authentication
├── supports(Class<?>) -> boolean
└── Implementations:
    ├── DaoAuthenticationProvider
    │   ├── UserDetailsService
    │   ├── PasswordEncoder
    │   └── UserDetailsChecker
    ├── LdapAuthenticationProvider
    ├── CasAuthenticationProvider
    ├── JwtAuthenticationProvider
    ├── OAuth2LoginAuthenticationProvider
    ├── AnonymousAuthenticationProvider
    └── RememberMeAuthenticationProvider
```

### 4.5 UserDetailsService Architecture
```
UserDetailsService (interface)
├── loadUserByUsername(String) -> UserDetails
└── Implementations:
    ├── InMemoryUserDetailsManager
    ├── JdbcUserDetailsManager
    ├── LdapUserDetailsService
    └── CachingUserDetailsService

UserDetails (interface)
├── getUsername() -> String
├── getPassword() -> String
├── getAuthorities() -> Collection<GrantedAuthority>
├── isAccountNonExpired() -> boolean
├── isAccountNonLocked() -> boolean
├── isCredentialsNonExpired() -> boolean
└── isEnabled() -> boolean
```

### 4.6 Authorization Architecture
```
AccessDecisionManager (interface - Deprecated)
├── decide(Authentication, Object, Collection<ConfigAttribute>)
├── supports(ConfigAttribute) -> boolean
└── supports(Class<?>) -> boolean

New Authorization Model:
AuthorizationManager<T> (interface)
├── check(Authentication, T) -> AuthorizationDecision
└── Implementations:
    ├── AuthorityAuthorizationManager
    ├── AuthenticatedAuthorizationManager
    ├── WebExpressionAuthorizationManager
    └── RequestMatcherDelegatingAuthorizationManager
```

### 4.7 Method Security Architecture
```
@EnableGlobalMethodSecurity / @EnableMethodSecurity
├── @PreAuthorize
├── @PostAuthorize
├── @PreFilter
├── @PostFilter
└── @Secured

MethodSecurityInterceptor
├── MethodSecurityMetadataSource
├── AuthorizationManager
└── AfterInvocationManager
```

## 5. Configuration Architecture

### 5.1 Java Configuration
```
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        return http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()
                .anyRequest().authenticated())
            .formLogin(form -> form
                .loginPage("/login")
                .defaultSuccessUrl("/dashboard"))
            .build();
    }
}
```

### 5.2 WebSecurityConfigurerAdapter (Deprecated)
```
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // Configuration
    }
    
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        // Authentication configuration
    }
}
```

## 6. Session Management Architecture

### 6.1 SessionRegistry
```
SessionRegistry
├── getAllPrincipals() -> List<Object>
├── getAllSessions(Object, boolean) -> List<SessionInformation>
├── getSessionInformation(String) -> SessionInformation
├── registerNewSession(String, Object)
├── removeSessionInformation(String)
└── refreshLastRequest(String)
```

### 6.2 Session Management Strategies
```
SessionAuthenticationStrategy
├── CompositeSessionAuthenticationStrategy
├── ConcurrentSessionControlAuthenticationStrategy
├── SessionFixationProtectionStrategy
├── RegisterSessionAuthenticationStrategy
└── NullAuthenticatedSessionStrategy
```

## 7. Exception Handling Architecture

### 7.1 Security Exceptions
```
AuthenticationException (abstract)
├── BadCredentialsException
├── UsernameNotFoundException
├── AccountExpiredException
├── AccountStatusException
├── CredentialsExpiredException
├── DisabledException
├── LockedException
└── InsufficientAuthenticationException

AccessDeniedException
├── Used for authorization failures
└── Handled by AccessDeniedHandler
```

### 7.2 Exception Handlers
```
AuthenticationEntryPoint
├── commence(HttpServletRequest, HttpServletResponse, AuthenticationException)
└── Implementations:
    ├── LoginUrlAuthenticationEntryPoint
    ├── BasicAuthenticationEntryPoint
    ├── DigestAuthenticationEntryPoint
    ├── Http403ForbiddenEntryPoint
    └── OAuth2LoginAuthenticationEntryPoint

AccessDeniedHandler
├── handle(HttpServletRequest, HttpServletResponse, AccessDeniedException)
└── Implementations:
    ├── AccessDeniedHandlerImpl
    └── DelegatingAccessDeniedHandler
```

## 8. Crypto and Password Encoding

### 8.1 PasswordEncoder Architecture
```
PasswordEncoder (interface)
├── encode(CharSequence) -> String
├── matches(CharSequence, String) -> boolean
├── upgradeEncoding(String) -> boolean
└── Implementations:
    ├── BCryptPasswordEncoder
    ├── SCryptPasswordEncoder
    ├── Pbkdf2PasswordEncoder
    ├── ArgonPasswordEncoder
    ├── NoOpPasswordEncoder (deprecated)
    └── DelegatingPasswordEncoder
```

### 8.2 Crypto Utilities
```
org.springframework.security.crypto
├── encrypt (Encryptors)
├── keygen (KeyGenerators)
└── password (PasswordEncoders)
```

## 9. OAuth2 and JWT Architecture

### 9.1 OAuth2 Client
```
OAuth2AuthorizedClientManager
├── OAuth2AuthorizedClientProvider
├── OAuth2AuthorizedClientRepository
└── OAuth2AuthorizedClient
    ├── ClientRegistration
    ├── OAuth2AccessToken
    └── OAuth2RefreshToken
```

### 9.2 OAuth2 Resource Server
```
JwtDecoder
├── JwtDecoderFactory
└── ReactiveJwtDecoder

JwtAuthenticationConverter
├── JwtGrantedAuthoritiesConverter
└── Converter<Jwt, AbstractAuthenticationToken>
```

## 10. Events and Monitoring

### 10.1 Security Events
```
ApplicationEventPublisher
├── AuthenticationSuccessEvent
├── AuthenticationFailureBadCredentialsEvent
├── AuthorizationEvent
├── SessionCreationEvent
├── SessionDestroyedEvent
└── LogoutSuccessEvent
```

### 10.2 Actuator Integration
```
Security Actuator Endpoints:
├── /actuator/sessions
├── /actuator/auditevents
└── Custom security metrics
```

## 11. Testing Architecture

### 11.1 Test Security
```
@WithMockUser
@WithUserDetails
@WithSecurityContext
@WithAnonymousUser

SecurityMockMvcRequestPostProcessors:
├── csrf()
├── user()
├── anonymous()
├── httpBasic()
└── oauth2Login()
```

This comprehensive architecture covers all micro-level components of Spring Security, showing how they interact and integrate to provide a complete security framework.
